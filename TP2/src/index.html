<!DOCTYPE html>
<html>
<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<link rel="stylesheet" href="vendors/css/bootstrap.css">
	<link rel="stylesheet" href="vendors/css/font-awesome.min.css">	
	<script src="vendors/js/jquery-3.2.1.min.js"></script>
	<script src="vendors/js/d3.min.js"></script>
	<script src="vendors/js/bootstrap.min.js"></script>
	<script src="assets/js/parser.js"></script>
</head>

<body>

 <script>


var svgContainer = d3.select('body').append("svg")
                                     .attr("opacity", 0.8)
                                     .attr("width", 1620)
                                     .attr("height", 500);
                                     
//------------------------------------                                     
           /*                          
svgContainer.append("rect")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("fill", "pink");
    */

var tooltip_bg = svgContainer.append("rect")
      .attr("x",50).attr("y", 50)
      .attr("rx", 5).attr("ry", 5)
      .attr("id", "tooltip_bg")
      .attr("width", 50).attr("height", 16)
      .attr("fill", "black")
      .attr("stroke", "black")
      .attr("stroke-width", "1")
      .attr("visibility", "hidden");
      

var tooltip = svgContainer.append("text")
	.attr("x",50).attr("y",50)
	.attr("id", "tooltip")
	.attr("visibility", "hidden")
	.text("TOOOOLS")
	.attr("font-family","sans-serif")
	.attr("font-size",12);
	

function ShowTooltip(evt, name, data){

  tooltip.attr("x",evt.clientX-8);
  tooltip.attr("y",evt.clientY-5);
  tooltip.attr("visibility","visible");
  
  tooltip_bg.attr("x",evt.clientX-8);
  tooltip_bg.attr("y",evt.clientY-5);
  tooltip_bg.attr("visibility","visible");

}

function HideTooltip(){
  tooltip.attr("visibility","hidden");
  tooltip_bg.attr("visibility","hidden");
}

//--------------------------------------
 
function createPeduncle( x0, y0, x0Fl, y0Fl, sz){

var line1 = svgContainer.append("line")
                          .attr("x1", x0)
                          .attr("y1", y0)
                          .attr("x2", x0Fl)
                          .attr("y2", y0Fl)
                          .attr("stroke-width", sz/2)
                          .attr("stroke", "#14320d");
}


function createPetal(x0, y0, v, rotation, color, sz){

var line1 = svgContainer.append("line")
                          .attr("x1", x0)
                          .attr("y1", y0)
                          .attr("x2", x0+v)
                          .attr("y2", y0)
                          .attr("stroke-width", sz)
                          .attr("stroke", color)
                          .attr("transform", "rotate( "+rotation+" "+x0+" "+y0+")")
                          .attr("class","petal");

}

function createFlower(name, data, v, sz, x0, y0, x0Fl, y0Fl){

	createPeduncle(x0, y0, x0Fl, y0Fl, sz);

	createPetal(x0Fl, y0Fl, v*data['civic engagement'], 2, '#4c9479', sz);
	createPetal(x0Fl, y0Fl, v*data['community'], 35, '#4c94bb', sz);
	createPetal(x0Fl, y0Fl, v*data['education'], 68, '#0004a0', sz);
	createPetal(x0Fl, y0Fl, v*data['environment'], 101, '#a84550', sz);
	createPetal(x0Fl, y0Fl, v*data['health'], 134, '#7ab536', sz);
	createPetal(x0Fl, y0Fl, v*data['housing'], 167, '#13ad33', sz);
	createPetal(x0Fl, y0Fl, v*data['income'], 200, '#debe1a', sz);
	createPetal(x0Fl, y0Fl, v*data['jobs'], 233, '#774998', sz);
	createPetal(x0Fl, y0Fl, v*data['life satisfaction'], 266, '#df390f', sz);
	createPetal(x0Fl, y0Fl, v*data['safety'], 299, '#39372a', sz);
	createPetal(x0Fl, y0Fl, v*data['work-life balance'], 332, '#5f0202', sz);


	var circle = svgContainer.append("circle")	
                         .attr("cx", x0Fl)
                         .attr("cy", y0Fl)
                         .attr("class", "flower_")
                         .attr("stroke-width", sz/2)
                         .attr("fill", "#b4a702")
                         .attr("stroke", "#e3ef02")
                         .attr("r", sz)
                         .attr("onmousemove", "ShowTooltip(evt, '"+name+"')")
						 .attr("onmouseout", "HideTooltip(evt)" );
                         

    var svgText = svgContainer.append("text").attr("x",x0Fl-(name.length*3+60)).attr("y",y0Fl-6)
		.text(name)
                .attr("class", "flower_")		
                .attr("transform", "rotate( 270 "+x0Fl+" "+y0Fl+")")
    			.attr("font-size"," "+(sz)+ " px");
}

function average(data){
  sum = parseFloat(data['civic engagement'])+parseFloat(data['community'])+parseFloat(data['education'])+parseFloat(data['environment'])+parseFloat(data['health'])+parseFloat(data['housing'])+
	    parseFloat(data['income'])+parseFloat(data['jobs'])+parseFloat(data['life satisfaction'])+parseFloat(data['safety'])+parseFloat(data['work-life balance']);
	    
  return sum/11.0;
}

var flowerCenterX = 40; //deslocamento horizontal da flor
var flowerCenterY = 400; //altura da flor

var value = 35;
var petlSize = 3;
var distance = 40;

//createFlower("name da flor", dataset, value, flowerCenterX, flowerPositionY0, flowerCenterX, flowerCenterY);
parseeverything("data/countries.json","data/data.csv", function(datajson,data){
  var initindex=0;
  for (i = 0; i < data.length; i++) {     
    height = average(data[i]);
    //NAME DEVE SER O RETORNO DE UMA FUNCAO QUE ACHA O NOME (NO ARQUIVO DE PAISES) A PARTIR DO CODIGO
    for (j=initindex; j<datajson.length;j++){
    	if (datajson[j]['code']==data[i]['country']){
    		name=datajson[j]['pt'];
    		initindex=j+1;
    	}
    }
    createFlower(name, data[i], value, petlSize, flowerCenterX+(i*distance), flowerCenterY, flowerCenterX+(i*distance), flowerCenterY*(1-height));
  }
  
});

</script>


</body>

</html>